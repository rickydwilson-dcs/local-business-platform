#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo ""
echo "ğŸ” Running pre-push quality checks..."
echo ""

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ“ Current branch: $BRANCH"
echo ""

# Always run these checks (existing behavior)
echo "â–¶ï¸  TypeScript validation..."
npm run type-check || {
  echo ""
  echo "âŒ TypeScript check failed"
  echo ""
  exit 1
}

echo ""
echo "â–¶ï¸  Production build test..."
npm run build || {
  echo ""
  echo "âŒ Build failed"
  echo ""
  exit 1
}

# NEW: Run smoke tests for protected branches
if [ "$BRANCH" = "develop" ] || [ "$BRANCH" = "staging" ] || [ "$BRANCH" = "main" ]; then
  echo ""
  echo "ğŸ­ Running smoke tests (required for $BRANCH)..."
  echo ""

  npm run test:e2e:smoke || {
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ SMOKE TESTS FAILED"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Smoke tests must pass before pushing to '$BRANCH'."
    echo ""
    echo "ğŸ”§ Troubleshooting:"
    echo "  1. Run 'npm run test:e2e:smoke' to see failures"
    echo "  2. Run 'npm run test:e2e:ui' for interactive debugging"
    echo "  3. Fix the failing tests"
    echo "  4. Try pushing again"
    echo ""
    echo "ğŸ’¡ Tip: These are minimal tests (HTTP 200 + H1 checks)."
    echo "    If they fail, something fundamental is broken."
    echo ""
    exit 1
  }
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-push checks passed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""