#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo ""
echo "ğŸ” Running pre-push quality checks..."
echo ""

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ“ Current branch: $BRANCH"
echo ""

# Always run these checks (existing behavior)
echo "â–¶ï¸  TypeScript validation..."
npm run type-check || {
  echo ""
  echo "âŒ TypeScript check failed"
  echo ""
  exit 1
}

echo ""
echo "â–¶ï¸  Production build test..."
npm run build || {
  echo ""
  echo "âŒ Build failed"
  echo ""
  exit 1
}

# Branch-specific quality gates
if [ "$BRANCH" = "main" ]; then
  # For main: Verify staging tests passed (staging is the quality gate)
  echo ""
  echo "ğŸ” Verifying staging E2E tests passed..."
  echo ""

  # Check if gh CLI is available
  if ! command -v gh &> /dev/null; then
    echo "âš ï¸  Warning: gh CLI not found - skipping staging verification"
    echo "   Install gh CLI to enable automatic staging test verification"
    echo ""
  else
    # Get the latest E2E test run status on staging
    STAGING_STATUS=$(gh run list --branch staging --workflow="E2E Tests" --limit 1 --json conclusion --jq '.[0].conclusion' 2>/dev/null)

    if [ "$STAGING_STATUS" != "success" ]; then
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "âŒ STAGING E2E TESTS MUST PASS FIRST"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "Staging is the final quality gate before main."
      echo "Current staging E2E status: $STAGING_STATUS"
      echo ""
      echo "ğŸ”§ Required steps:"
      echo "  1. Ensure all changes are merged to staging"
      echo "  2. Wait for staging E2E tests to pass"
      echo "  3. Verify: gh run list --branch staging --workflow='E2E Tests' --limit 1"
      echo "  4. Then push to main"
      echo ""
      exit 1
    fi

    echo "âœ… Staging E2E tests passed - safe to deploy to main"
  fi

elif [ "$BRANCH" = "develop" ] || [ "$BRANCH" = "staging" ]; then
  # For develop/staging: Run smoke tests locally
  echo ""
  echo "ğŸ­ Running smoke tests (required for $BRANCH)..."
  echo ""

  npm run test:e2e:smoke || {
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ SMOKE TESTS FAILED"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Smoke tests must pass before pushing to '$BRANCH'."
    echo ""
    echo "ğŸ”§ Troubleshooting:"
    echo "  1. Run 'npm run test:e2e:smoke' to see failures"
    echo "  2. Run 'npm run test:e2e:ui' for interactive debugging"
    echo "  3. Fix the failing tests"
    echo "  4. Try pushing again"
    echo ""
    echo "ğŸ’¡ Tip: These are minimal tests (HTTP 200 + H1 checks)."
    echo "    If they fail, something fundamental is broken."
    echo ""
    exit 1
  }
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All pre-push checks passed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""