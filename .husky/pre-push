#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo ""
echo "๐ Running pre-push quality checks..."
echo ""

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "๐ Current branch: $BRANCH"
echo ""

# Always run these checks (existing behavior)
echo "โถ๏ธ  TypeScript validation..."
npm run type-check || {
  echo ""
  echo "โ TypeScript check failed"
  echo ""
  exit 1
}

echo ""
echo "โถ๏ธ  Production build test..."
npm run build || {
  echo ""
  echo "โ Build failed"
  echo ""
  exit 1
}

# Branch-specific quality gates
if [ "$BRANCH" = "main" ]; then
  # For main: Verify staging tests passed (staging is the quality gate)
  echo ""
  echo "๐ Verifying staging E2E tests passed..."
  echo ""

  # Check if gh CLI is available
  if ! command -v gh &> /dev/null; then
    echo "โ๏ธ  Warning: gh CLI not found - skipping staging verification"
    echo "   Install gh CLI to enable automatic staging test verification"
    echo ""
  else
    # Get the latest E2E test run status on staging
    STAGING_STATUS=$(gh run list --branch staging --workflow="E2E Tests" --limit 1 --json conclusion --jq '.[0].conclusion' 2>/dev/null)

    if [ "$STAGING_STATUS" != "success" ]; then
      echo ""
      echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
      echo "โ STAGING E2E TESTS MUST PASS FIRST"
      echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
      echo ""
      echo "Staging is the final quality gate before main."
      echo "Current staging E2E status: $STAGING_STATUS"
      echo ""
      echo "๐ง Required steps:"
      echo "  1. Ensure all changes are merged to staging"
      echo "  2. Wait for staging E2E tests to pass"
      echo "  3. Verify: gh run list --branch staging --workflow='E2E Tests' --limit 1"
      echo "  4. Then push to main"
      echo ""
      exit 1
    fi

    echo "โ Staging E2E tests passed - safe to deploy to main"
  fi

elif [ "$BRANCH" = "develop" ] || [ "$BRANCH" = "staging" ]; then
  # For develop/staging: Run smoke tests locally
  echo ""
  echo "๐งน Cleaning build cache to prevent corruption..."
  echo ""

  # Clean .next directories to prevent corrupted build cache issues
  # This prevents 404/500 errors during smoke tests caused by stale webpack chunks
  find sites -name ".next" -type d -exec rm -rf {} + 2>/dev/null || true

  echo ""
  echo "๐ญ Running smoke tests (required for $BRANCH)..."
  echo ""

  npm run test:e2e:smoke || {
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ SMOKE TESTS FAILED"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "Smoke tests must pass before pushing to '$BRANCH'."
    echo ""
    echo "๐ง Troubleshooting:"
    echo "  1. Run 'npm run test:e2e:smoke' to see failures"
    echo "  2. Run 'npm run test:e2e:ui' for interactive debugging"
    echo "  3. Fix the failing tests"
    echo "  4. Try pushing again"
    echo ""
    echo "๐ก Tip: These are minimal tests (HTTP 200 + H1 checks)."
    echo "    If they fail, something fundamental is broken."
    echo ""
    echo "๐ See docs/troubleshooting/CORRUPTED_BUILD_CACHE.md for common issues"
    echo ""
    exit 1
  }
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ All pre-push checks passed!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""